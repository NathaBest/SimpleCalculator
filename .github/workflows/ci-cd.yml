name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build project
        run: |
          javac src/Main.java  # Adjust path as needed

      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build-artifacts
          path: ./src/*.class  # Adjust this path to include the compiled .class files

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Run tests
        run: |
          echo "No tests to run"  # Replace with actual test commands when ready

      - name: Upload test results
        uses: actions/upload-artifact@v3
        with:
          name: test-results
          path: .

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to staging
        run: |
          echo "Deploying to staging environment..."  # Replace with actual deployment commands

  notify:
    name: Notify Teams on Build Success
    runs-on: ubuntu-latest
    needs: build
    if: success()
    
    steps:
      - name: Notify Microsoft Teams
        uses: actions/github-script@v6
        with:
          script: |
            const fetch = require('node-fetch');
            const webhookUrl = process.env.TEAMS_WEBHOOK_URL;
            const message = {
              "@type": "MessageCard",
              "@context": "https://schema.org/extensions",
              "themeColor": "0076D7",
              "title": "Build Successful",
              "text": `The build for commit [${process.env.GITHUB_SHA}](https://github.com/${process.env.GITHUB_REPOSITORY}/commit/${process.env.GITHUB_SHA}) was successful!`,
              "sections": [{
                "facts": [
                  {
                    "name": "Repository:",
                    "value": process.env.GITHUB_REPOSITORY
                  },
                  {
                    "name": "Commit:",
                    "value": process.env.GITHUB_SHA
                  },
                  {
                    "name": "Build URL:",
                    "value": `${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`
                  }
                ]
              }]
            };

            fetch(webhookUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(message)
            }).then(res => {
              if (!res.ok) {
                throw new Error('Failed to send message to Teams');
              }
            }).catch(err => {
              console.error(err);
              process.exit(1);
            });
        env:
          TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
